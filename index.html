<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title></title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css">
  <script>
  const byId = elm => document.getElementById(elm)
  const getHash = () => document.location.hash.substr(1).split(":")[0]
  const getDeepLink = () => document.location.hash.substr(1).split(":")[1]
  const convertBase64 = str => window.atob(str)
  const fetchJson = (url, callback) => fetch(url).then(response => response.json()).then(callback)
  const metaUrl = parts => `https://gist.githubusercontent.com/${parts[0]}/${parts[1]}/raw/Meta.json`
  const insert = (elementId, template) =>  {
    const elm = document.createElement("div")
    elm.innerHTML = template
    byId(elementId).innerHTML += elm.innerHTML
  }

  let urlHash;
  let modalImage, modal;

  class ImageGrid {
    constructor(gridBasis=300, className="grid") {
      this.gridBasis = gridBasis
      this.className = className
      this.gridElement = this.gridElement.bind(this)
    }

    gridElement(image) {
        var img = new Image()
        var ratio = image.width_m / image.height_m
        const elm = `<div class="${this.className}__element"
               data-image="${image.url_l}"
               data-id="${image.id}"
               style="flex-basis: ${this.gridBasis*ratio}px; flex-grow: ${ratio}">
            <img src="${image.url_m}">
            <div class="${this.className}__title">
              <p>${image.title}</p>
            </div>
          </div>`
        insert("grid", elm)
    }

    buildGrid(images) {
      images.forEach(this.gridElement)
    }
  }

  const closeModal = () => {
    document.querySelector(".active").classList.remove("active")
    byId("modal").classList.remove("show")
    modalImage.onload = null
    document.location.hash = urlHash

  }

  const fly = direction => {
    const opposite = direction === "left" ? "right" : "left"
    modal.classList.add(`fly-${direction}`)
    modalImage.onload = () => {
      modal.classList.remove(`fly-${direction}`)
      modal.classList.add(`flyback${opposite}`)
      setTimeout(() => { modal.classList.remove(`flyback${opposite}`) }, 500)
    }
  }

  const setStyle = style => {
    byId("body", `<style>${style}</style>`)
  }

  const init = () => {
    urlHash = getHash()
    if (!urlHash) return;

    const metaInfo = convertBase64(urlHash)
    const url = metaUrl(metaInfo.split(":"))

    modalImage = byId("image")
    modal = byId("modal")

    // Fetch json container
    fetchJson(url, response => {
      // Once we've got our json container fetch photoset info and the actuall photos
      fetchJson(response.info, getInfo)
      fetchJson(response.photoset, getPhotos)

      if (response.style) setStyle(response.style)
    })

    byId("modal").addEventListener("click", closeModal)

    byId("grid").addEventListener("click", e => {
      console.log(e);
      if(e.path.length !== 8 && e.path.length !== 9) return;

      const image = e.path.length === 9 ? e.path[1] : e.path[0]
      if (image) {
        byId("image").src = image.getAttribute("data-image")
        byId("modal").classList.add("show")
        image.classList.add("active")
        document.location.hash = `${urlHash}:${image.getAttribute("data-id")}`
      }
    })

    window.addEventListener("keydown", e => {
      var nextImg
      var currentImg = document.querySelector(".active")
      modal.classList.remove("fly-right")
      modal.classList.remove("fly-left")
      modal.classList.remove("flybackright")
      modal.classList.remove("flybackleft")

      switch (e.key) {
        case "ArrowRight":
          nextImg = currentImg.nextElementSibling
          if (!nextImg) break // We're at the first image, do nothing.
          fly("left")
          break
        case "ArrowLeft":
          nextImg = currentImg.previousElementSibling
          if (! nextImg) break // We're at the last image, do nothing.
          fly("right")
          break
        case "Escape":
          closeModal()
          break
      }

      if (nextImg) {
        setTimeout(() => {
          currentImg.classList.remove("active")
          nextImg.classList.add("active")
          modalImage.src = nextImg.getAttribute("data-image")
        }, 200)
      }
    }, false)
  }

  const getInfo = response => {
    const {title, description, username} = response.photoset;
    const template = `<div id="heading">
        <h1>${title._content}</h1>
        <h2>${description._content}</h2>
        <p>
          Photos by
          <a href="https://www.flickr.com/photos/${username}/">
            ${username}
          </a>
        </p>
      </div>`;
    insert("head", template)
  }

  /*
   * Set a cover photo for the photoset.
   * If no primary photo is selected default to the first photo in the photoset
   **/
  const setCoverPhoto = photos => {
    var primary = photos.filter(photo => photo.isprimary == "1")
    primary = primary.length ? primary[0] : photos[0]
    byId("cover-photo").style.backgroundImage = `url(${primary.url_o})`
  }

  const getPhotos = response => {
    setCoverPhoto(response.photoset.photo)
    new ImageGrid().buildGrid(response.photoset.photo)

    const deepLink = getDeepLink()
    if (deepLink) {
      document.querySelector(`[data-id="${deepLink}"]`).click()
    }
   }
  </script>
</head>
<body id="body">
  <header id="head">
    <div id="cover-photo"></div>
  </header>
  <div id="grid" class="grid"></div>
  <div id="modal" class="modal">
    <div>
      <img id="image" src="">
    </div>
  </div>
  <script>init()</script>
</body>
</html>
